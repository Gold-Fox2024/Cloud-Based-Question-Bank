<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯é¢˜åº“</title>
    <style>
        :root {
            /* --- æ ¸å¿ƒå˜é‡ --- */
            --app-fs: 16px; /* å…¨å±€åŸºç¡€å­—å·å˜é‡ */
            
            /* æµ…è‰²æ¨¡å¼å˜é‡ */
            --primary: #4776E6;
            --primary-grad: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%);
            --accent: #00d2ff;
            --bg: #f3f6fa;
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #2d3436;
            --text-sub: #636e72;
            --input-bg: #f8fafc;
            --input-border: #edf2f7;
            --success: #00b894;
            --success-bg: #d1fae5;
            --danger: #ff7675;
            --danger-bg: #fee2e2;
            --warning: #f1c40f;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* æ·±è‰²æ¨¡å¼å˜é‡è¦†ç›– */
        body.dark-theme {
            --primary: #5c8bf7;
            --primary-grad: linear-gradient(135deg, #5c8bf7 0%, #a270f2 100%);
            --bg: #121212;
            --glass: rgba(30, 30, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --success-bg: rgba(0, 184, 148, 0.2);
            --danger-bg: rgba(255, 118, 117, 0.2);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: var(--text-main);
            font-size: var(--app-fs); 
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .bg-blob {
            position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.6;
            animation: float 10s infinite ease-in-out; pointer-events: none;
        }
        body.dark-theme .bg-blob { opacity: 0.25; }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #8E54E9; }
        .blob-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: #00d2ff; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, 50px); } }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: var(--glass);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.3s;
        }
        .header-title { 
            font-weight: 800; 
            font-size: calc(var(--app-fs) + 4px); 
            background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            letter-spacing: -0.5px; 
        }
        
        .header-controls { display: flex; gap: 8px; align-items: center; }

        /* å·²ä¸ºæ‚¨åŠ å®½ */
        .cat-select {
            background: rgba(71, 118, 230, 0.1);
            border: 1px solid rgba(71, 118, 230, 0.2);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            outline: none;
            max-width: 160px; /* åŠ å®½ */
            min-width: 110px;
        }

        .icon-btn {
            background: transparent; border: none; 
            font-size: 18px; cursor: pointer; padding: 5px;
            color: var(--text-main); border-radius: 50%;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); }
        .icon-btn:active { transform: scale(0.9); }
        body.dark-theme .icon-btn:hover { background: rgba(255,255,255,0.1); }
        
        .font-btn { font-size: 14px; font-weight: bold; width: auto; padding: 0 4px; }

        .container { padding: 20px; padding-bottom: 120px; max-width: 800px; margin: 0 auto; }
        
        .card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .welcome-card { background: var(--primary-grad); color: white; border: none; position: relative; overflow: hidden; }
        
        .achievement-mini {
            position: absolute; top: 15px; right: 15px; 
            background: rgba(255,255,255,0.2); padding: 5px 10px; 
            border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer;
            backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px;
        }
        
        .mode-card {
            background: var(--glass);
            padding: 20px; border-radius: 18px; text-align: center; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: all 0.2s;
        }
        .mode-card:active { transform: scale(0.96); }
        .mode-icon { font-size: 32px; display: block; margin-bottom: 8px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        .mode-title { font-weight: 700; font-size: var(--app-fs); color: var(--text-main); }
        .mode-desc { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

        .question-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 20px; }
        h3 { 
            margin: 0; 
            font-size: calc(var(--app-fs) + 3px);
            font-weight: 700; color: var(--text-main); 
            line-height: 1.6; flex: 1; 
        }

        .fav-star {
            font-size: calc(var(--app-fs) + 8px); 
            color: var(--text-sub); opacity: 0.3; cursor: pointer;
            transition: all 0.2s; line-height: 1; flex-shrink: 0; margin-top: 2px;
        }
        .fav-star.active { color: var(--warning); transform: scale(1.1); opacity: 1; text-shadow: 0 0 15px rgba(241, 196, 15, 0.6); }
        
        input, textarea, select {
            width: 100%; padding: 14px; margin: 8px 0;
            border: 2px solid var(--input-border); border-radius: 12px;
            box-sizing: border-box; 
            font-size: var(--app-fs);
            background: var(--input-bg); color: var(--text-main);
            transition: all 0.3s; font-family: inherit;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); outline: none; }
        
        .btn {
            display: block; width: 100%; padding: 14px;
            background: var(--primary-grad); color: white;
            border: none; border-radius: 12px;
            font-size: var(--app-fs); font-weight: 600; cursor: pointer;
            margin-top: 10px; box-shadow: 0 4px 15px rgba(71, 118, 230, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 118, 117, 0.3); }
        .btn-sm { padding: 8px 16px; font-size: 13px; width: auto; display: inline-block; margin: 0; }
        .btn-group { display: flex; gap: 12px; margin-top: 15px; }
        .btn-group .btn { margin-top: 0; flex: 1; }

        .option-label {
            display: flex; padding: 18px 16px;
            background: var(--glass);
            margin-bottom: 15px; border-radius: 16px; 
            cursor: pointer; border: 2px solid transparent; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            transition: all 0.2s; align-items: flex-start;
        }
        .option-label.active-candidate { border-color: var(--primary); background-color: rgba(71, 118, 230, 0.05); }
        .option-label.correct { background: var(--success-bg); border-color: var(--success); }
        .option-label.wrong { background: var(--danger-bg); border-color: var(--danger); }

        .option-key {
            font-weight: 800; color: var(--primary);
            width: 32px; height: 32px; border-radius: 50%; 
            background: rgba(71, 118, 230, 0.1);
            display: flex; align-items: center; justify-content: center;
            margin-right: 14px; flex-shrink: 0; font-size: 14px; 
            transition: all 0.2s; margin-top: 2px;
        }
        .option-label.correct .option-key { background: var(--success); color: white; }
        .option-label.wrong .option-key { background: var(--danger); color: white; }
        .option-text { 
            line-height: 1.6; 
            color: var(--text-main); 
            font-size: var(--app-fs);
            word-break: break-word; text-align: justify; 
        }
        
        .result-box { 
            margin-top: 8px; padding: 0; border-radius: 12px; 
            text-align: center; font-weight: 600; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            overflow: hidden;
        }
        .result-box-long { text-align: left !important; font-weight: normal; white-space: pre-wrap; line-height: 1.7; padding: 15px; width: 100%; box-sizing: border-box; }
        .res-correct { background: var(--success-bg); color: #008f6d; padding: 15px; }
        .res-wrong { background: var(--danger-bg); color: #c0392b; padding: 15px; }
        body.dark-theme .res-correct { color: #55efc4; }
        body.dark-theme .res-wrong { color: #ff7675; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .checkbox-group { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .checkbox-label {
            min-width: 40px; display: flex; align-items: center; justify-content: center;
            padding: 10px; border: 2px solid var(--input-border); border-radius: 10px; cursor: pointer;
            font-weight: bold; color: var(--text-sub); background: var(--input-bg);
            font-size: var(--app-fs);
        }
        .checkbox-label input { display: none; }
        .checkbox-label:has(input:checked) { border-color: #8E54E9; background: rgba(142, 84, 233, 0.1); color: #8E54E9; }

        .tab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 10px; border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            z-index: 999; border: 1px solid rgba(255,255,255,0.4);
        }
        body.dark-theme .tab-bar { background: rgba(40, 40, 40, 0.8); border-color: rgba(255,255,255,0.1); }
        .tab-item { text-align: center; padding: 10px 20px; cursor: pointer; color: #b2bec3; transition: all 0.3s; border-radius: 15px; }
        .tab-item.active { color: white; background: var(--primary-grad); box-shadow: 0 4px 15px rgba(71, 118, 230, 0.4); }
        .tab-icon { font-size: 20px; display: block; line-height: 1; margin-bottom: 2px; }
        .tab-text { font-size: 12px; font-weight: 600; }

        .list-item {
            display: flex; align-items: flex-start; gap: 15px;
            padding: 16px; border-bottom: 1px solid var(--input-border);
            background: var(--glass); border-radius: 12px; margin-bottom: 8px;
            transition: all 0.2s;
        }
        .list-item:hover { transform: translateX(5px); }
        .check-area { width: 30px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 3px; }
        .list-check { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
        .list-info { flex: 1; min-width: 0; font-size: var(--app-fs); line-height: 1.6; color: var(--text-main); cursor: pointer; }
        .list-title { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; word-break: break-all; margin-top: 4px; }
        
        .badge { display: inline-block; padding: 3px 8px; font-size: 11px; border-radius: 6px; color: white; margin-right: 5px; vertical-align: middle; }
        .badge-choice { background: #4776E6; }
        .badge-multiple { background: #9b59b6; } 
        .badge-judge { background: #FF9500; }
        .badge-text { background: #00b894; }
        .badge-essay { background: #6c5ce7; }

        /* ä¿®å¤åçš„æ‚¬æµ®æ“ä½œæ æ ·å¼ */
        .floating-action-bar {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #2d3436; color: white;
            padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 800; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: max-content;
        }
        .floating-action-bar.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .fab-count { background: #fff; color: #000; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 12px; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--glass); backdrop-filter: blur(10px);
            color: var(--text-main); padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); font-weight: 600;
            z-index: 2000; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; border: 1px solid var(--glass-border);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
        }
        .modal-card {
            background: var(--bg); width: 85%; max-width: 340px;
            padding: 30px; border-radius: 24px; color: var(--text-main);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            animation: slideUp 0.3s ease; position: relative; max-height: 80vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .achievement-modal { text-align: center; background: linear-gradient(135deg, #1e272e 0%, #111 100%); color: #fff; border: 2px solid #ffd700; }
        .achievement-icon { font-size: 60px; margin-bottom: 10px; animation: bounce 1s infinite; display: inline-block; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .hidden { display: none !important; }
        
        .empty-state-card { text-align: center; padding: 40px 20px; }
        .empty-icon { font-size: 60px; margin-bottom: 15px; display: block; opacity: 0.8; }
        
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .badge-item { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 5px; text-align: center; opacity: 0.4; filter: grayscale(1); transition: all 0.3s; }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0); background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); }
        .badge-img { font-size: 24px; display: block; margin-bottom: 5px; }
        .badge-name { font-size: 10px; display: block; color: var(--text-sub); }

        /* å¯¼å…¥æ–‡æœ¬åŒºåŸŸ */
        .import-area {
            width: 100%; height: 200px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 15px;
            color: var(--text-main);
            font-family: monospace;
            font-size: 13px;
            resize: none;
        }
        .import-preview {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            color: var(--text-sub);
        }
    </style>
</head>
<body>

<div class="bg-blob blob-1"></div>
<div class="bg-blob blob-2"></div>

<div id="toast"><span>âœ… æ“ä½œæˆåŠŸ</span></div>

<div class="header">
    <div class="header-title" id="app-title">äº‘ç«¯é¢˜åº“</div>
    <div class="header-controls">
        <select id="category-select" class="cat-select" onchange="switchCategory(this.value)"></select>
        <button class="icon-btn font-btn" onclick="adjustFontSize(-1)">A-</button>
        <button class="icon-btn font-btn" onclick="adjustFontSize(1)">A+</button>
        <button class="icon-btn" onclick="toggleTheme()" id="theme-btn">â˜€ï¸</button>
    </div>
</div>

<div class="container">
    
    <!-- ç»ƒä¹ é¡µ -->
    <div id="view-practice">
        <div id="dashboard">
            <div class="card welcome-card">
                <div class="achievement-mini" onclick="openAchievementModal()">
                    <span>ğŸ†</span> <span id="global-correct-mini">0</span>
                </div>
                <h2 style="margin:0; font-size:22px;">ğŸ‘‹ å‡†å¤‡å¥½ç»ƒä¹ äº†å—ï¼Ÿ</h2>
                <p style="margin:8px 0 0 0; opacity:0.9; font-size:14px;">å½“å‰é¢˜åº“ï¼š<span id="current-cat-display" style="font-weight:bold;">é»˜è®¤</span></p>
                <div style="margin-top:10px; font-size:13px; background:rgba(255,255,255,0.2); display:inline-block; padding:4px 10px; border-radius:8px;">
                    ğŸ“š é¢˜åº“å…± <span id="current-count">0</span> é“é¢˜
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="mode-card" onclick="startPractice('order')">
                    <span class="mode-icon">ğŸ“</span>
                    <div class="mode-title">é¡ºåºåˆ·é¢˜</div>
                    <div class="mode-desc">å¾ªåºæ¸è¿›ï¼Œä¸è®¡å…¥é”™é¢˜</div>
                </div>
                <div class="mode-card" onclick="startPractice('random')">
                    <span class="mode-icon">ğŸ”€</span>
                    <div class="mode-title">ä¹±åºåˆ·é¢˜</div>
                    <div class="mode-desc">éšæœºæŒ‘æˆ˜ï¼Œè®¡å…¥é”™é¢˜</div>
                </div>
                <div class="mode-card" onclick="openSimModal()">
                    <span class="mode-icon">â±ï¸</span>
                    <div class="mode-title">æ¨¡æ‹Ÿè€ƒè¯•</div>
                    <div class="mode-desc">ä»¿çœŸæµ‹éªŒï¼Œè®¡å…¥é”™é¢˜</div>
                </div>
                <div class="mode-card" onclick="startPractice('favorite')">
                    <span class="mode-icon">â­</span>
                    <div class="mode-title">æˆ‘çš„æ”¶è—</div>
                    <div class="mode-desc">é‡ç‚¹å¤ä¹ æ”¶è—å†…å®¹</div>
                </div>
                <div class="mode-card" onclick="startPractice('mistake')">
                    <span class="mode-icon">ğŸ“•</span>
                    <div class="mode-title">é”™é¢˜æœ¬</div>
                    <div class="mode-desc">æ”»å…‹è–„å¼±ç¯èŠ‚</div>
                </div>
            </div>
        </div>

        <div id="empty-state-view" class="hidden">
            <div class="card empty-state-card">
                <span class="empty-icon" id="empty-state-icon">ğŸ‰</span>
                <h3 id="empty-state-title">ç©ºç©ºå¦‚ä¹Ÿ</h3>
                <p style="color:var(--text-sub); margin-bottom:20px;" id="empty-state-desc">å¤ªæ£’äº†ï¼è¿™é‡Œæ²¡æœ‰ä»»ä½•å†…å®¹ã€‚</p>
                <button class="btn btn-outline" style="width: auto; margin: 0 auto; display: inline-block; padding: 8px 30px;" onclick="exitPractice()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <div id="practice-area" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <button class="btn btn-sm btn-outline" style="border-radius:20px; padding:6px 15px;" onclick="exitPractice()">ğŸ”™ ç»“æŸ</button>
                
                <div style="display:flex; align-items:center; gap:15px;">
                    <span id="accuracy-display" style="font-size:14px; font-weight:600; color:var(--success); background:var(--success-bg); padding:4px 8px; border-radius:8px;">ğŸ¯ 0%</span>
                    <span id="progress-text" style="font-size:15px; font-weight:800; color:var(--primary);">1 / 10</span>
                </div>
            </div>

            <div id="question-card-container" style="position:relative;">
                <div id="question-card" class="card" style="min-height: 300px;">
                    <!-- é¢˜ç›®å†…å®¹ -->
                </div>
            </div>
            
            <div class="btn-group" id="nav-btns">
                <button class="btn btn-outline" onclick="navQuestion(-1)">ä¸Šä¸€é¢˜</button>
                <button class="btn" onclick="navQuestion(1)">ä¸‹ä¸€é¢˜</button>
            </div>

            <div id="jump-control-area" class="jump-box hidden" style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <input type="number" id="jump-val" style="width:60px; padding:8px; margin:0; text-align:center;" placeholder="#">
                <button class="btn btn-sm" style="margin:0; width:auto; padding:6px 15px;" onclick="performJump()">è·³è½¬</button>
            </div>
            
            <div id="mistake-actions" class="hidden" style="margin-top:10px;">
                <button class="btn btn-danger" onclick="removeFromMistakes()">ğŸ—‘ï¸ æˆ‘å­¦ä¼šäº† (ç§»é™¤æ­¤é¢˜)</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†é¡µ -->
    <div id="view-manage" class="hidden">
        <div class="card">
            <h3>ğŸ“‚ æ–°å»ºåˆ†ç±»</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-cat-name" placeholder="ä¾‹å¦‚: é©¬å…‹æ€ä¸»ä¹‰" style="margin:0;">
                <button class="btn" style="width:80px; margin:0;" onclick="addCategory()">åˆ›å»º</button>
            </div>
        </div>

        <!-- æ‰¹é‡å¯¼å…¥å¡ç‰‡ -->
        <div class="card" onclick="openImportModal()" style="cursor:pointer; display:flex; align-items:center; gap:15px; background:linear-gradient(135deg, #6c5ce7, #a29bfe); color:white;">
            <div style="font-size:30px;">ğŸš€</div>
            <div>
                <div style="font-weight:bold; font-size:16px;">æ™ºèƒ½æ‰¹é‡å¯¼å…¥</div>
                <div style="font-size:12px; opacity:0.9; margin-top:2px;">æ”¯æŒç²˜è´´æ–‡æœ¬ï¼Œè‡ªåŠ¨è¯†åˆ«é¢˜ç›®/é€‰é¡¹/ç­”æ¡ˆ</div>
            </div>
        </div>

        <div class="card" id="edit-form-card">
            <h3 id="form-title">âœï¸ æ·»åŠ é¢˜ç›®</h3>
            <div id="edit-mode-indicator" class="hidden" style="background:var(--warning); color:#fff; padding:10px; border-radius:10px; margin-bottom:15px; font-size:13px; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#333; font-weight:bold;">æ­£åœ¨ä¿®æ”¹é¢˜ç›®</span>
                <button class="btn-sm" style="background:rgba(255,255,255,0.3); color:#333; border:none;" onclick="resetForm()">å–æ¶ˆ</button>
            </div>

            <select id="in-type" onchange="toggleFormInputs()">
                <option value="choice">å•é¡¹é€‰æ‹©é¢˜</option>
                <option value="multiple">å¤šé¡¹é€‰æ‹©é¢˜</option>
                <option value="judge">åˆ¤æ–­é¢˜</option>
                <option value="text">ç®€ç­”é¢˜</option>
                <option value="essay">è®ºè¿°é¢˜</option>
            </select>
            
            <textarea id="in-title" rows="3" placeholder="åœ¨è¿™é‡Œè¾“å…¥é¢˜ç›®å†…å®¹..."></textarea>
            
            <div id="box-options-wrapper" class="hidden">
                <div id="dynamic-options-container"></div>
                <button class="btn btn-outline btn-sm" style="margin-bottom:15px;" onclick="addOptionInput()">â• æ·»åŠ ä¸€ä¸ªé€‰é¡¹</button>
            </div>

            <div id="box-choice-ans" class="hidden">
                <select id="in-ans-choice"><option value="" disabled selected>ğŸ‘‡ é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ (å•é€‰)</option></select>
            </div>

            <div id="box-multiple-ans" class="hidden">
                <p style="margin:5px 0 5px 0; font-size:13px; color:var(--text-sub);">ğŸ‘‡ å‹¾é€‰æ‰€æœ‰æ­£ç¡®ç­”æ¡ˆ (å¤šé€‰)</p>
                <div class="checkbox-group" id="dynamic-checkbox-container"></div>
            </div>

            <div id="box-judge-ans" class="hidden">
                <select id="in-ans-judge">
                    <option value="æ­£ç¡®">æ­£ç¡®</option>
                    <option value="é”™è¯¯">é”™è¯¯</option>
                </select>
            </div>

            <div id="box-text-ans" class="hidden">
                <textarea id="in-ans-text" rows="5" placeholder="è¾“å…¥å‚è€ƒç­”æ¡ˆ..."></textarea>
            </div>

            <button class="btn" onclick="saveQuestionItem()">ğŸ’¾ ä¿å­˜é¢˜ç›®</button>
        </div>
        
        <div class="card" style="padding-bottom: 60px;">
            <h3>ğŸ“š é¢˜ç›®åˆ—è¡¨</h3>
            <div style="position:relative; margin-bottom:10px;">
                <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." oninput="handleSearch(this.value)" style="padding-left:35px;">
                <span style="position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:0.5;">ğŸ”</span>
            </div>
            
            <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <label style="font-size:14px; color:var(--text-sub); display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="select-all-box" onchange="toggleSelectAll(this)" style="width:18px; height:18px; margin:0;">
                    å…¨é€‰å½“å‰é¡µ
                </label>
                <span style="font-size:12px; color:var(--text-sub);" id="list-total-hint"></span>
            </div>

            <div id="manage-list"></div>
        </div>

        <div class="card">
            <h3>âš™ï¸ æ•°æ®ä¸è®¾ç½®</h3>
            <button class="btn btn-outline" onclick="exportData()">ğŸ“¤ å¯¼å‡ºé¢˜åº“å¤‡ä»½</button>
            <button class="btn btn-outline" style="margin-top:10px" onclick="document.getElementById('file-input').click()">ğŸ“¥ å¯¼å…¥å¤‡ä»½æ–‡ä»¶</button>
            <input type="file" id="file-input" hidden accept=".json" onchange="importData(this)">
            <div style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:15px;">
                <button class="btn btn-danger btn-sm" onclick="deleteCurrentCategory()">ğŸš¨ åˆ é™¤å½“å‰é¢˜åº“åˆ†ç±»</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œæ‚¬æµ®æ  (ä¿®å¤) -->
<div id="batch-bar" class="floating-action-bar">
    <span>å·²é€‰ <span class="fab-count" id="selected-count">0</span></span>
    <div style="height:20px; width:1px; background:rgba(255,255,255,0.3);"></div>
    <span onclick="openMigrateModal()" style="cursor:pointer; font-weight:600;">ğŸ“‚ è¿ç§»/å¤åˆ¶</span>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('practice')">
        <span class="tab-icon">âœï¸</span><span class="tab-text">ç»ƒä¹ </span>
    </div>
    <div class="tab-item" onclick="switchTab('manage')">
        <span class="tab-icon">ğŸ› ï¸</span><span class="tab-text">ç®¡ç†</span>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šæ‰¹é‡å¯¼å…¥ -->
<div id="import-text-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width:500px; width:90%;">
        <h3 style="margin-top:0">ğŸ“ æ™ºèƒ½æ–‡æœ¬å¯¼å…¥</h3>
        <p style="font-size:12px; color:var(--text-sub);">
            è¯·å°†é¢˜ç›®æ–‡æœ¬ç²˜è´´åˆ°ä¸‹æ–¹ã€‚æ ¼å¼ç¤ºä¾‹ï¼š<br>
            1. é¢˜ç›®å†…å®¹ <br>
            A. é€‰é¡¹ä¸€ <br>
            B. é€‰é¡¹äºŒ <br>
            ç­”æ¡ˆï¼šA
        </p>
        <textarea id="import-textarea" class="import-area" placeholder="1. é¢˜ç›®...&#10;A. é€‰é¡¹...&#10;B. é€‰é¡¹...&#10;ç­”æ¡ˆï¼šA"></textarea>
        
        <div id="import-preview-box" class="import-preview hidden"></div>
        
        <div class="btn-group">
            <button class="btn btn-outline" onclick="closeImportModal()">å–æ¶ˆ</button>
            <button class="btn" id="btn-parse" onclick="parseAndPreview()">ğŸ” è¯†åˆ«é¢„è§ˆ</button>
            <button class="btn hidden" id="btn-confirm-import" onclick="confirmImport()">âœ… ç¡®è®¤å¯¼å…¥</button>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šè¿ç§»/å¤åˆ¶ (ä¿®å¤) -->
<div id="migrate-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <h3 style="margin-top:0">ğŸš€ æ‰¹é‡æ“ä½œ</h3>
        <p style="font-size:14px; color:var(--text-sub);">å°†é€‰ä¸­çš„ <strong id="migrate-count-display">0</strong> é“é¢˜ç›®ï¼š</p>
        <label style="font-size:12px; color:var(--text-sub);">ç›®æ ‡é¢˜åº“</label>
        <select id="target-cat-select" style="margin-top:5px; background:var(--input-bg); border-color:var(--input-border);"></select>
        <div style="display:grid; gap:10px; margin-top:20px;">
            <button class="btn" style="background:var(--success); margin:0;" onclick="executeMigrate('copy')">ğŸ“‘ ä»…å¤åˆ¶ (ä¿ç•™åŸé¢˜)</button>
            <button class="btn" style="background:var(--primary); margin:0;" onclick="executeMigrate('move')">ğŸšš ç§»åŠ¨ (ä»åŸåº“åˆ é™¤)</button>
        </div>
        <button class="btn btn-sm" style="background:transparent; color:var(--text-sub); margin-top:15px; width:100%; box-shadow:none;" onclick="document.getElementById('migrate-modal').classList.add('hidden')">å–æ¶ˆ</button>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šæ¨¡æ‹Ÿè€ƒè¯• -->
<div id="sim-modal" class="modal-overlay hidden">
    <div class="modal-card">
        <h3 style="margin-top:0">â±ï¸ ç”Ÿæˆè¯•å·</h3>
        <p style="font-size:13px; color:var(--text-sub); margin-bottom:15px;">è¯·è¾“å…¥å„é¢˜å‹æŠ½å–çš„æ•°é‡ï¼š</p>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label style="font-size:12px;">å•é€‰ (ä½™:<span id="stock-choice">0</span>)</label><input type="number" id="sim-count-choice" value="10"></div>
            <div><label style="font-size:12px;">å¤šé€‰ (ä½™:<span id="stock-multiple">0</span>)</label><input type="number" id="sim-count-multiple" value="5"></div>
            <div><label style="font-size:12px;">åˆ¤æ–­ (ä½™:<span id="stock-judge">0</span>)</label><input type="number" id="sim-count-judge" value="5"></div>
            <div><label style="font-size:12px;">ç®€ç­” (ä½™:<span id="stock-text">0</span>)</label><input type="number" id="sim-count-text" value="2"></div>
            <div><label style="font-size:12px;">è®ºè¿° (ä½™:<span id="stock-essay">0</span>)</label><input type="number" id="sim-count-essay" value="1"></div>
        </div>

        <div class="btn-group">
            <button class="btn btn-outline" onclick="document.getElementById('sim-modal').classList.add('hidden')">å–æ¶ˆ</button>
            <button class="btn" onclick="startSimulation()">å¼€å§‹è€ƒè¯•</button>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šæˆå°±å¢™ -->
<div id="achievement-list-modal" class="modal-overlay hidden">
    <div class="modal-card" style="max-width:350px;">
        <h3 style="margin-top:0; text-align:center;">ğŸ† æˆ‘çš„æˆå°±</h3>
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:14px; color:var(--text-sub);">ç´¯è®¡ç­”å¯¹é¢˜ç›®</div>
            <div style="font-size:32px; font-weight:800; color:var(--warning);" id="modal-total-correct">0</div>
        </div>
        
        <div class="badge-grid" id="badge-container"></div>
        <button class="btn" style="margin-top:20px;" onclick="document.getElementById('achievement-list-modal').classList.add('hidden')">å…³é—­</button>
    </div>
</div>

<!-- æ¨¡æ€æ¡†ï¼šè§£é”æˆå°±ç‰¹æ•ˆ -->
<div id="unlock-modal" class="modal-overlay hidden">
    <div class="modal-card achievement-modal">
        <div class="achievement-icon">ğŸ–ï¸</div>
        <h2 style="margin:10px 0; color:#ffd700;">è§£é”æ–°æˆå°±!</h2>
        <h3 id="unlock-title" style="margin:5px 0;">åˆå‡ºèŒ…åº</h3>
        <p style="font-size:14px; opacity:0.8;">ç´¯è®¡ç­”å¯¹ <span id="unlock-count">10</span> é“é¢˜</p>
        <button class="btn" style="background:#ffd700; color:#000; margin-top:20px;" onclick="document.getElementById('unlock-modal').classList.add('hidden')">å¤ªæ£’äº†!</button>
    </div>
</div>

<script>
    let appData = { categories: ['é»˜è®¤é¢˜åº“'], questions: { 'é»˜è®¤é¢˜åº“': [] } };
    let mistakes = [];
    let currentCategory = 'é»˜è®¤é¢˜åº“';
    let runMode = 'order'; 
    let runList = []; 
    let runIndex = 0;
    let editIndex = -1; 
    let searchKeyword = ''; 
    let sessionCorrect = 0; 
    let sessionTotal = 0;   
    let totalGlobalCorrect = 0;
    let currentFontSize = 16; 

    // å¯¼å…¥ç¼“å­˜
    let parsedQuestionsCache = [];

    const BADGES = [
        { limit: 10, name: "åˆå‡ºèŒ…åº", icon: "ğŸŒ±" },
        { limit: 50, name: "æ¸å…¥ä½³å¢ƒ", icon: "ğŸƒ" },
        { limit: 100, name: "ç†Ÿèƒ½ç”Ÿå·§", icon: "ğŸ”¨" },
        { limit: 300, name: "é¢˜æµ·å†²æµª", icon: "ğŸ„" },
        { limit: 500, name: "åšå­¦å¤šæ‰", icon: "ğŸ“" },
        { limit: 1000, name: "ç™»å³°é€ æ", icon: "ğŸ‘‘" },
    ];

    window.onload = function() {
        loadData();
        loadSettings(); 
        renderCategorySelect();
        updateDashboardInfo();
        updateAccuracyUI();
        toggleFormInputs();
        updateBadgeUI();
        showToast("ğŸ‘‹ æ¬¢è¿å›æ¥ï¼");
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerHTML = `<span>${msg}</span>`;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function loadData() {
        const stored = localStorage.getItem('qb_data_v2');
        if (stored) appData = JSON.parse(stored);
        
        const storedMistakes = localStorage.getItem('qb_mistakes');
        if (storedMistakes) mistakes = JSON.parse(storedMistakes);

        const storedCount = localStorage.getItem('qb_total_correct');
        if (storedCount) totalGlobalCorrect = parseInt(storedCount);
        
        if (!appData.categories) appData.categories = ['é»˜è®¤é¢˜åº“'];
        if (!appData.questions) appData.questions = { 'é»˜è®¤é¢˜åº“': [] };
    }

    function saveData() {
        localStorage.setItem('qb_data_v2', JSON.stringify(appData));
        updateDashboardInfo();
    }
    
    function saveMistakes() {
        localStorage.setItem('qb_mistakes', JSON.stringify(mistakes));
    }

    function saveGlobalStats() {
        localStorage.setItem('qb_total_correct', totalGlobalCorrect);
        updateBadgeUI();
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        localStorage.setItem('qb_theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-btn').innerText = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    function adjustFontSize(delta) {
        currentFontSize += delta;
        if(currentFontSize < 12) currentFontSize = 12;
        if(currentFontSize > 24) currentFontSize = 24;
        applyFontSize();
        localStorage.setItem('qb_fontsize', currentFontSize);
        showToast(`å­—ä½“å¤§å°: ${currentFontSize}px`);
    }

    function applyFontSize() {
        document.documentElement.style.setProperty('--app-fs', currentFontSize + 'px');
    }

    function loadSettings() {
        const theme = localStorage.getItem('qb_theme');
        if(theme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('theme-btn').innerText = 'ğŸŒ™';
        } else {
            document.getElementById('theme-btn').innerText = 'â˜€ï¸';
        }
        const fs = localStorage.getItem('qb_fontsize');
        if(fs) {
            currentFontSize = parseInt(fs);
            applyFontSize();
        }
    }

    // --- æ‰¹é‡å¯¼å…¥åŠŸèƒ½ ---
    function openImportModal() {
        document.getElementById('import-text-modal').classList.remove('hidden');
        document.getElementById('import-textarea').value = '';
        document.getElementById('import-preview-box').classList.add('hidden');
        document.getElementById('btn-parse').classList.remove('hidden');
        document.getElementById('btn-confirm-import').classList.add('hidden');
        parsedQuestionsCache = [];
    }

    function closeImportModal() {
        document.getElementById('import-text-modal').classList.add('hidden');
    }

    function parseAndPreview() {
        const text = document.getElementById('import-textarea').value;
        if(!text.trim()) return showToast("âš ï¸ è¯·è¾“å…¥æ–‡æœ¬å†…å®¹");
        
        const lines = text.split('\n');
        let questions = [];
        let currentQ = null;

        const reQuestion = /^\s*(\d+[\.\ã€\s]|[\(ï¼ˆ]\d+[\)ï¼‰])\s*(.*)/;
        const reOption = /^\s*([A-Z])[\.\ã€\)\s]\s*(.*)/i;
        const reAnswer = /^\s*(ç­”æ¡ˆ|Answer|Correct)[:ï¼š\s]*([A-Z]+|æ­£ç¡®|é”™è¯¯|âˆš|Ã—)/i;

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            const qMatch = line.match(reQuestion);
            if (qMatch) {
                if (currentQ) questions.push(currentQ);
                currentQ = { id: Date.now() + Math.random(), type: 'choice', title: qMatch[2], options: [], answer: '', isFavorite: false };
                return;
            }

            const optMatch = line.match(reOption);
            if (currentQ && optMatch) {
                currentQ.options.push(optMatch[2]);
                return;
            }

            const ansMatch = line.match(reAnswer);
            if (currentQ && ansMatch) {
                let ans = ansMatch[2].toUpperCase().replace(/\s/g, '');
                if(ans === 'âˆš' || ans === 'T') ans = 'æ­£ç¡®';
                if(ans === 'Ã—' || ans === 'F') ans = 'é”™è¯¯';
                currentQ.answer = ans;
                if(currentQ.options.length === 0 && (ans === 'æ­£ç¡®' || ans === 'é”™è¯¯')) currentQ.type = 'judge';
                else if (ans.length > 1 && !['æ­£ç¡®','é”™è¯¯'].includes(ans)) currentQ.type = 'multiple';
                else currentQ.type = 'choice';
                return;
            }

            if (currentQ) {
                if(currentQ.options.length > 0) currentQ.options[currentQ.options.length - 1] += " " + line;
                else currentQ.title += "\n" + line;
            }
        });
        if (currentQ) questions.push(currentQ);

        if(questions.length === 0) return showToast("âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼");

        parsedQuestionsCache = questions;
        const previewBox = document.getElementById('import-preview-box');
        previewBox.classList.remove('hidden');
        previewBox.innerHTML = `
            <div style="margin-bottom:5px; font-weight:bold; color:var(--primary);">
                ğŸ‰ æˆåŠŸè¯†åˆ«åˆ° ${questions.length} é“é¢˜
            </div>
            ${questions.map((q, i) => `
                <div style="border-bottom:1px solid var(--input-border); padding:5px 0;">
                    <span style="font-weight:bold;">${i+1}. [${getTypeName(q.type)}]</span> ${q.title.substring(0,20)}...<br>
                    <span style="color:var(--success);">ç­”æ¡ˆ: ${q.answer}</span>
                </div>
            `).join('')}
        `;

        document.getElementById('btn-parse').classList.add('hidden');
        document.getElementById('btn-confirm-import').classList.remove('hidden');
    }

    function confirmImport() {
        if(parsedQuestionsCache.length === 0) return;
        const list = appData.questions[currentCategory];
        parsedQuestionsCache.forEach(q => list.push(q));
        saveData();
        renderManageList();
        updateDashboardInfo();
        closeImportModal();
        showToast(`âœ… æˆåŠŸå¯¼å…¥ ${parsedQuestionsCache.length} é“é¢˜ç›®ï¼`);
    }

    // --- å¥–åŠ±ç³»ç»Ÿé€»è¾‘ ---
    function incrementCorrectCount() {
        totalGlobalCorrect++;
        saveGlobalStats();
        checkBadgeUnlock();
    }

    function checkBadgeUnlock() {
        const badge = BADGES.find(b => b.limit === totalGlobalCorrect);
        if(badge) {
            document.getElementById('unlock-title').innerText = badge.name;
            document.getElementById('unlock-count').innerText = badge.limit;
            document.getElementById('unlock-modal').classList.remove('hidden');
            showToast(`è§£é”æˆå°±ï¼š${badge.name}`);
        }
    }

    function updateBadgeUI() {
        document.getElementById('global-correct-mini').innerText = totalGlobalCorrect;
        document.getElementById('modal-total-correct').innerText = totalGlobalCorrect;
    }

    function openAchievementModal() {
        const container = document.getElementById('badge-container');
        container.innerHTML = '';
        BADGES.forEach(b => {
            const isUnlocked = totalGlobalCorrect >= b.limit;
            const div = document.createElement('div');
            div.className = `badge-item ${isUnlocked ? 'unlocked' : ''}`;
            div.innerHTML = `
                <span class="badge-img">${b.icon}</span>
                <span class="badge-name">${b.name} (${b.limit})</span>
            `;
            container.appendChild(div);
        });
        document.getElementById('achievement-list-modal').classList.remove('hidden');
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    function renderCategorySelect() {
        const sel = document.getElementById('category-select');
        sel.innerHTML = '';
        appData.categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.text = cat;
            if(cat === currentCategory) opt.selected = true;
            sel.appendChild(opt);
        });
        document.getElementById('current-cat-display').innerText = currentCategory;
    }

    function switchCategory(newCat) {
        currentCategory = newCat;
        document.getElementById('current-cat-display').innerText = newCat;
        if(!document.getElementById('view-manage').classList.contains('hidden')) renderManageList();
        updateDashboardInfo();
        exitPractice();
        showToast(`å·²åˆ‡æ¢è‡³ï¼š${newCat}`);
    }

    function addCategory() {
        const name = document.getElementById('new-cat-name').value.trim();
        if(!name) return showToast("âš ï¸ è¯·è¾“å…¥åç§°");
        if(appData.categories.includes(name)) return showToast("âš ï¸ åˆ†ç±»å·²å­˜åœ¨");
        appData.categories.push(name);
        appData.questions[name] = [];
        saveData();
        currentCategory = name;
        renderCategorySelect();
        document.getElementById('new-cat-name').value = '';
        switchCategory(name);
    }

    function deleteCurrentCategory() {
        if(currentCategory === 'é»˜è®¤é¢˜åº“') return showToast("ğŸš« é»˜è®¤é¢˜åº“æ— æ³•åˆ é™¤");
        if(!confirm(`ç¡®å®šè¦å½»åº•åˆ é™¤ã€${currentCategory}ã€‘å—ï¼Ÿ`)) return;
        delete appData.questions[currentCategory];
        appData.categories = appData.categories.filter(c => c !== currentCategory);
        currentCategory = 'é»˜è®¤é¢˜åº“';
        saveData();
        renderCategorySelect();
        switchCategory('é»˜è®¤é¢˜åº“');
    }

    function updateDashboardInfo() {
        const count = (appData.questions[currentCategory] || []).length;
        document.getElementById('current-count').innerText = count;
        document.getElementById('list-total-hint').innerText = `å…± ${count} é¢˜`;
    }

    function updateAccuracyUI() {
        let rate = 0;
        if (sessionTotal > 0) rate = Math.round((sessionCorrect / sessionTotal) * 100);
        document.getElementById('accuracy-display').innerText = `ğŸ¯ ${rate}%`;
    }

    function getCharByIndex(index) { return String.fromCharCode(65 + index); }

    function renderOptionInputs(optionsArray = []) {
        const container = document.getElementById('dynamic-options-container');
        container.innerHTML = ''; 
        if (optionsArray.length === 0) optionsArray = ['', ''];
        optionsArray.forEach((text, index) => {
            const row = document.createElement('div');
            row.style.cssText = "display:flex;gap:10px;margin-bottom:10px;align-items:center;";
            row.innerHTML = `
                <div style="width:30px;height:30px;background:var(--input-border);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:bold;">${getCharByIndex(index)}</div>
                <input type="text" class="in-opt-dynamic" value="${escapeHtml(text)}" placeholder="é€‰é¡¹ ${getCharByIndex(index)}" oninput="syncAnswerSelectors()" style="margin:0;">
                <button class="btn btn-danger" style="width:40px;margin:0;padding:0;height:48px;" onclick="removeOptionInput(this)">ğŸ—‘ï¸</button>
            `;
            container.appendChild(row);
        });
        refreshAnswerSelectors(); 
    }

    function addOptionInput() {
        const container = document.getElementById('dynamic-options-container');
        const index = container.children.length;
        const row = document.createElement('div');
        row.style.cssText = "display:flex;gap:10px;margin-bottom:10px;align-items:center;";
        row.innerHTML = `
            <div style="width:30px;height:30px;background:var(--input-border);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-weight:bold;">${getCharByIndex(index)}</div>
            <input type="text" class="in-opt-dynamic" placeholder="é€‰é¡¹ ${getCharByIndex(index)}" oninput="syncAnswerSelectors()" style="margin:0;">
            <button class="btn btn-danger" style="width:40px;margin:0;padding:0;height:48px;" onclick="removeOptionInput(this)">ğŸ—‘ï¸</button>
        `;
        container.appendChild(row);
        refreshAnswerSelectors();
    }

    function removeOptionInput(btn) {
        const container = document.getElementById('dynamic-options-container');
        if (container.children.length <= 2) return showToast("âš ï¸ è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹");
        btn.parentElement.remove();
        Array.from(container.children).forEach((child, idx) => {
            child.children[0].innerText = getCharByIndex(idx);
            child.children[1].placeholder = `é€‰é¡¹ ${getCharByIndex(idx)}`;
        });
        refreshAnswerSelectors();
    }

    function refreshAnswerSelectors() {
        const count = document.getElementById('dynamic-options-container').children.length;
        const choiceSelect = document.getElementById('in-ans-choice');
        const currentChoiceVal = choiceSelect.value;
        choiceSelect.innerHTML = '<option value="" disabled selected>ğŸ‘‡ é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ (å•é€‰)</option>';
        for(let i=0; i<count; i++) {
            const char = getCharByIndex(i);
            const opt = document.createElement('option');
            opt.value = char; opt.text = char;
            choiceSelect.appendChild(opt);
        }
        if(currentChoiceVal && currentChoiceVal.charCodeAt(0) - 65 < count) choiceSelect.value = currentChoiceVal;

        const multiContainer = document.getElementById('dynamic-checkbox-container');
        const currentChecks = Array.from(document.querySelectorAll('.chk-ans:checked')).map(el => el.value);
        multiContainer.innerHTML = '';
        for(let i=0; i<count; i++) {
            const char = getCharByIndex(i);
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const checkedStr = currentChecks.includes(char) ? 'checked' : '';
            label.innerHTML = `<input type="checkbox" class="chk-ans" value="${char}" ${checkedStr}> ${char}`;
            multiContainer.appendChild(label);
        }
    }

    function syncAnswerSelectors() {}

    function toggleFormInputs() {
        const t = document.getElementById('in-type').value;
        const needOptions = (t === 'choice' || t === 'multiple');
        const isTextType = (t === 'text' || t === 'essay');
        const wrapper = document.getElementById('box-options-wrapper');
        
        if (needOptions) {
            wrapper.classList.remove('hidden');
            if (document.getElementById('dynamic-options-container').children.length === 0) renderOptionInputs(['', '']); 
        } else {
            wrapper.classList.add('hidden');
        }

        document.getElementById('box-choice-ans').classList.toggle('hidden', t !== 'choice');
        document.getElementById('box-multiple-ans').classList.toggle('hidden', t !== 'multiple');
        document.getElementById('box-judge-ans').classList.toggle('hidden', t !== 'judge');
        document.getElementById('box-text-ans').classList.toggle('hidden', !isTextType);
    }

    function saveQuestionItem() {
        const type = document.getElementById('in-type').value;
        const title = document.getElementById('in-title').value.trim();
        if(!title) return showToast("âš ï¸ é¢˜ç›®å†…å®¹ä¸èƒ½ä¸ºç©º");

        let q = { id: Date.now(), type, title };
        
        if (type === 'choice' || type === 'multiple') {
            const inputs = document.querySelectorAll('.in-opt-dynamic');
            q.options = Array.from(inputs).map(input => input.value.trim());
            if (q.options.some(opt => opt === '')) return showToast("âš ï¸ é€‰é¡¹å†…å®¹ä¸èƒ½ä¸ºç©º");
            if (type === 'choice') {
                q.answer = document.getElementById('in-ans-choice').value;
                if(!q.answer) return showToast("âš ï¸ è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ");
            } else { 
                const checked = Array.from(document.querySelectorAll('.chk-ans:checked')).map(el => el.value);
                if(checked.length === 0) return showToast("âš ï¸ è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ");
                q.answer = checked.sort().join(''); 
            }
        } else if (type === 'judge') {
            q.answer = document.getElementById('in-ans-judge').value;
        } else { 
            q.answer = document.getElementById('in-ans-text').value.trim();
            if(!q.answer) return showToast("âš ï¸ å‚è€ƒç­”æ¡ˆä¸èƒ½ä¸ºç©º");
        }
        
        q.isFavorite = false;
        const list = appData.questions[currentCategory];
        if(editIndex >= 0) {
            q.id = list[editIndex].id;
            q.isFavorite = list[editIndex].isFavorite || false;
            list[editIndex] = q;
            showToast("âœ… ä¿®æ”¹æˆåŠŸ");
        } else {
            list.push(q);
            showToast("âœ… æ·»åŠ æˆåŠŸ");
        }
        saveData();
        resetForm();
        renderManageList();
    }

    function editQuestion(idx) {
        editIndex = idx;
        const q = appData.questions[currentCategory][idx];
        document.getElementById('form-title').innerText = "âœï¸ ä¿®æ”¹é¢˜ç›®";
        document.getElementById('edit-mode-indicator').classList.remove('hidden');
        document.getElementById('in-type').value = q.type;
        
        if(q.type === 'choice' || q.type === 'multiple') {
            toggleFormInputs(); 
            renderOptionInputs(q.options); 
            if (q.type === 'choice') document.getElementById('in-ans-choice').value = q.answer;
            else { 
                const ans = q.answer.split(''); 
                document.querySelectorAll('.chk-ans').forEach(chk => {
                    chk.checked = ans.includes(chk.value);
                });
            }
        } else {
            toggleFormInputs();
            if(q.type === 'judge') document.getElementById('in-ans-judge').value = q.answer;
            else document.getElementById('in-ans-text').value = q.answer;
        }
        document.getElementById('in-title').value = q.title;
        document.querySelector('.container').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        editIndex = -1;
        document.getElementById('form-title').innerText = "âœï¸ æ·»åŠ é¢˜ç›®";
        document.getElementById('edit-mode-indicator').classList.add('hidden');
        document.getElementById('in-type').value = 'choice'; 
        document.getElementById('in-title').value = '';
        document.getElementById('in-ans-text').value = '';
        renderOptionInputs(['', '']); 
        toggleFormInputs(); 
        document.getElementById('in-ans-judge').value = "æ­£ç¡®"; 
    }

    function delQuestion(idx) {
        if(confirm("ç¡®å®šåˆ é™¤æ­¤é¢˜å—ï¼Ÿ")) {
            const qId = appData.questions[currentCategory][idx].id;
            appData.questions[currentCategory].splice(idx, 1);
            mistakes = mistakes.filter(m => m.id !== qId);
            saveMistakes();
            saveData();
            renderManageList();
            if(editIndex === idx) resetForm(); 
            showToast("âœ… é¢˜ç›®å·²åˆ é™¤");
        }
    }

    function toggleFavorite() {
        const currentQ = runList[runIndex];
        currentQ.isFavorite = !currentQ.isFavorite;
        
        const originalList = appData.questions[currentCategory];
        const target = originalList.find(q => q.id === currentQ.id);
        if(target) {
            target.isFavorite = currentQ.isFavorite;
            saveData();
        }

        const star = document.querySelector('.fav-star');
        if(currentQ.isFavorite) {
            star.classList.add('active');
            star.innerText = 'â­';
            showToast('å·²æ”¶è—');
        } else {
            star.classList.remove('active');
            star.innerText = 'â˜†';
            showToast('å·²å–æ¶ˆæ”¶è—');
        }
    }

    function startPractice(mode) {
        runMode = mode;
        const sourceList = appData.questions[currentCategory] || [];
        
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('empty-state-view').classList.add('hidden');
        
        if (mode === 'mistake') {
            runList = mistakes;
            document.getElementById('empty-state-icon').innerText = 'ğŸ‰';
            document.getElementById('empty-state-title').innerText = 'å¤ªæ£’äº†ï¼';
            document.getElementById('empty-state-desc').innerText = 'é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼Œç»§ç»­ä¿æŒï¼';
        } else if (mode === 'favorite') {
            runList = sourceList.filter(q => q.isFavorite);
            document.getElementById('empty-state-icon').innerText = 'â­';
            document.getElementById('empty-state-title').innerText = 'è¿˜æ²¡æœ‰æ”¶è—';
            document.getElementById('empty-state-desc').innerText = 'åœ¨ç»ƒä¹ ä¸­ç‚¹å‡»æ˜Ÿæ˜Ÿå³å¯æ”¶è—é¢˜ç›®ã€‚';
        } else if (mode === 'order') {
            runList = [...sourceList];
        } else if (mode === 'random') {
            runList = [...sourceList].sort(() => Math.random() - 0.5);
        }

        if (runList.length === 0) {
            if (mode === 'order' || mode === 'random') {
                showToast("ğŸ“­ é¢˜åº“æ˜¯ç©ºçš„ï¼Œè¯·å…ˆæ·»åŠ é¢˜ç›®");
                exitPractice(); 
            } else {
                document.getElementById('empty-state-view').classList.remove('hidden');
            }
            return;
        }

        sessionCorrect = 0; sessionTotal = 0;
        updateAccuracyUI();

        document.getElementById('practice-area').classList.remove('hidden');
        document.getElementById('mistake-actions').classList.toggle('hidden', mode !== 'mistake');
        document.getElementById('jump-control-area').classList.toggle('hidden', mode !== 'order');
        
        runIndex = 0;
        renderQuestionCard();
    }

    function performJump() {
        const input = document.getElementById('jump-val');
        const val = parseInt(input.value);
        if(isNaN(val) || val < 1 || val > runList.length) return showToast(`âš ï¸ è¯·è¾“å…¥ 1 - ${runList.length} ä¹‹é—´çš„æœ‰æ•ˆé¢˜å·`);
        runIndex = val - 1;
        renderQuestionCard();
        input.value = ''; 
        showToast(`ğŸš€ å·²è·³è½¬è‡³ç¬¬ ${val} é¢˜`);
    }

    function openSimModal() {
        const list = appData.questions[currentCategory] || [];
        if(list.length === 0) return showToast("ğŸ“­ é¢˜åº“æ˜¯ç©ºçš„");
        
        const counts = { choice: 0, multiple: 0, judge: 0, text: 0, essay: 0 };
        list.forEach(q => counts[q.type] = (counts[q.type] || 0) + 1);
        
        document.getElementById('stock-choice').innerText = counts.choice || 0;
        document.getElementById('stock-multiple').innerText = counts.multiple || 0;
        document.getElementById('stock-judge').innerText = counts.judge || 0;
        document.getElementById('stock-text').innerText = counts.text || 0;
        document.getElementById('stock-essay').innerText = counts.essay || 0;
        document.getElementById('sim-modal').classList.remove('hidden');
    }

    function startSimulation() {
        const nChoice = parseInt(document.getElementById('sim-count-choice').value) || 0;
        const nMultiple = parseInt(document.getElementById('sim-count-multiple').value) || 0;
        const nJudge = parseInt(document.getElementById('sim-count-judge').value) || 0;
        const nText = parseInt(document.getElementById('sim-count-text').value) || 0;
        const nEssay = parseInt(document.getElementById('sim-count-essay').value) || 0;
        
        const list = appData.questions[currentCategory];
        const choices = list.filter(q => q.type === 'choice').sort(() => Math.random() - 0.5).slice(0, nChoice);
        const multiples = list.filter(q => q.type === 'multiple').sort(() => Math.random() - 0.5).slice(0, nMultiple);
        const judges = list.filter(q => q.type === 'judge').sort(() => Math.random() - 0.5).slice(0, nJudge);
        const texts = list.filter(q => q.type === 'text').sort(() => Math.random() - 0.5).slice(0, nText);
        const essays = list.filter(q => q.type === 'essay').sort(() => Math.random() - 0.5).slice(0, nEssay);
        
        const examList = [...choices, ...multiples, ...judges, ...texts, ...essays];
        if(examList.length === 0) return showToast("âš ï¸ è¯·è‡³å°‘æŠ½å– 1 é“é¢˜");
        
        document.getElementById('sim-modal').classList.add('hidden');
        runMode = 'sim';
        runList = examList;
        runIndex = 0;
        
        sessionCorrect = 0; sessionTotal = 0;
        updateAccuracyUI();

        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('practice-area').classList.remove('hidden');
        document.getElementById('mistake-actions').classList.add('hidden');
        document.getElementById('jump-control-area').classList.add('hidden');
        
        renderQuestionCard();
    }

    function exitPractice() {
        document.getElementById('practice-area').classList.add('hidden');
        document.getElementById('empty-state-view').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        runList = [];
    }

    function navQuestion(offset) {
        const next = runIndex + offset;
        if(next < 0) return showToast("å·²ç»æ˜¯ç¬¬ä¸€é¢˜");
        if(next >= runList.length) {
            showToast("ğŸ‰ å·²å®Œæˆæ‰€æœ‰é¢˜ç›®");
            return exitPractice(); 
        }
        runIndex = next;
        renderQuestionCard();
    }

    function renderQuestionCard() {
        const q = runList[runIndex];
        const card = document.getElementById('question-card');
        document.getElementById('progress-text').innerText = `${runIndex + 1} / ${runList.length}`;
        
        let typeLabel = '';
        if(q.type === 'choice') typeLabel = '<span class="badge badge-choice">å•é€‰</span>';
        else if(q.type === 'multiple') typeLabel = '<span class="badge badge-multiple">å¤šé€‰</span>';
        else if(q.type === 'judge') typeLabel = '<span class="badge badge-judge">åˆ¤æ–­</span>';
        else if(q.type === 'text') typeLabel = '<span class="badge badge-text">ç®€ç­”</span>';
        else if(q.type === 'essay') typeLabel = '<span class="badge badge-essay">è®ºè¿°</span>';

        const isFav = q.isFavorite === true;
        const starClass = isFav ? 'active' : '';
        const starIcon = isFav ? 'â­' : 'â˜†';

        let html = `
            <div class="question-header">
                <h3>${typeLabel} ${escapeHtml(q.title)}</h3>
                <div class="fav-star ${starClass}" onclick="toggleFavorite()">${starIcon}</div>
            </div>
        `;

        if (q.type === 'choice' || q.type === 'multiple') {
            let originalOpts = q.options;
            let mappedOpts = originalOpts.map((txt, i) => {
                const keyChar = String.fromCharCode(65 + i); 
                return { 
                    text: txt, 
                    key: keyChar, 
                    isCorrect: q.type === 'choice' ? keyChar === q.answer : q.answer.includes(keyChar) 
                };
            });

            if (runMode === 'random' || runMode === 'sim') mappedOpts.sort(() => Math.random() - 0.5);

            html += `<div class="opts-list">`;
            mappedOpts.forEach((opt) => {
                if (q.type === 'choice') {
                    html += `<div class="option-label" onclick="checkAnswerChoice(this, ${opt.isCorrect})">
                                <span class="option-key">${opt.key}</span>
                                <span class="option-text">${escapeHtml(opt.text)}</span>
                             </div>`;
                } else {
                    html += `<div class="option-label" onclick="toggleMultipleOption(this)" data-correct="${opt.isCorrect}">
                                <span class="option-key">${opt.key}</span>
                                <span class="option-text">${escapeHtml(opt.text)}</span>
                             </div>`;
                }
            });
            html += `</div>`;
            
            if (q.type === 'choice') {
                const correctOpt = mappedOpts.find(o => o.isCorrect);
                const ansKey = correctOpt ? correctOpt.key : q.answer;
                html += `<div id="ans-hidden" class="hidden">${ansKey}</div>`;
            }
            if (q.type === 'multiple') {
                html += `<button id="btn-submit-multiple" class="btn" onclick="submitMultipleAnswer()">ç¡®è®¤ç­”æ¡ˆ</button>`;
                const correctVisualLabels = mappedOpts.filter(o => o.isCorrect).map(o => o.key).sort().join('');
                html += `<div id="ans-hidden" class="hidden">${correctVisualLabels}</div>`;
            }

        } else if (q.type === 'judge') {
            html += `<div class="opts-list">
                        <div class="option-label" onclick="checkAnswerChoice(this, '${q.answer}'==='æ­£ç¡®')">
                            <span class="option-key">A</span> <span class="option-text">æ­£ç¡®</span>
                        </div>
                        <div class="option-label" onclick="checkAnswerChoice(this, '${q.answer}'==='é”™è¯¯')">
                            <span class="option-key">B</span> <span class="option-text">é”™è¯¯</span>
                        </div>
                     </div>`;
        } else { 
            html += `<div onclick="this.nextElementSibling.classList.remove('hidden')" style="padding:10px 0; text-align:center; background:rgba(0,0,0,0.05); border-radius:12px; color:var(--text-sub); cursor:pointer; border:2px dashed var(--input-border); font-size:14px;">ğŸ‘€ ç‚¹å‡»æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</div>
                     <div class="result-box result-box-long hidden" style="background:var(--success-bg); color:#00695c;">
                        <div style="font-size:16px; font-weight:bold; margin-bottom:8px;">å‚è€ƒç­”æ¡ˆï¼š</div>
                        <div style="text-align: left;">${escapeHtml(q.answer)}</div>
                     </div>`;
        }
        html += `<div id="result-feedback" class="result-box hidden"></div>`;
        card.innerHTML = html;
    }

    function checkAnswerChoice(el, isCorrect) {
        if(el.parentElement.querySelector('.checked')) return; 
        el.parentElement.querySelectorAll('.option-label').forEach(d => d.classList.add('checked'));
        
        sessionTotal++;
        if (isCorrect) {
            sessionCorrect++;
            incrementCorrectCount(); 
        }
        updateAccuracyUI();

        const feedback = document.getElementById('result-feedback');
        feedback.classList.remove('hidden');

        if (isCorrect) {
            el.classList.add('correct');
            feedback.innerHTML = "ğŸ‰ å›ç­”æ­£ç¡®ï¼";
            feedback.className = "result-box res-correct";
        } else {
            el.classList.add('wrong');
            let correctMsg = "";
            const hiddenAns = document.getElementById('ans-hidden');
            if(hiddenAns) correctMsg = "æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š" + hiddenAns.innerText;
            else correctMsg = "æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š" + (el.innerText.includes('æ­£ç¡®')?'é”™è¯¯':'æ­£ç¡®');

            feedback.innerHTML = `âŒ å›ç­”é”™è¯¯ï¼${correctMsg}`;
            feedback.className = "result-box res-wrong";
            
            if (runMode !== 'mistake' && runMode !== 'order') addToMistakes(runList[runIndex]);
        }
    }

    function toggleMultipleOption(el) {
        if(document.getElementById('result-feedback').classList.contains('hidden') === false) return; 
        el.classList.toggle('active-candidate');
    }

    function submitMultipleAnswer() {
        const options = document.querySelectorAll('.option-label');
        let allCorrect = true;
        let selectedCount = 0;
        let correctCountActual = 0; 

        options.forEach(opt => {
            const isSelected = opt.classList.contains('active-candidate');
            const isActuallyCorrect = opt.getAttribute('data-correct') === 'true';
            if(isActuallyCorrect) correctCountActual++; 
            if(isSelected) selectedCount++; 

            if (isSelected && isActuallyCorrect) opt.classList.add('correct'); 
            else if (isSelected && !isActuallyCorrect) { opt.classList.add('wrong'); allCorrect = false; }
            else if (!isSelected && isActuallyCorrect) { opt.style.border = "2px dashed var(--success)"; allCorrect = false; }
        });

        if (selectedCount === 0) return showToast("âš ï¸ è¯·å…ˆé€‰æ‹©ç­”æ¡ˆ");

        const feedback = document.getElementById('result-feedback');
        feedback.classList.remove('hidden');
        document.getElementById('btn-submit-multiple').style.display = 'none';

        sessionTotal++;
        const isFullyCorrect = allCorrect && (selectedCount === correctCountActual);
        if (isFullyCorrect) {
            sessionCorrect++;
            incrementCorrectCount(); 
        }
        updateAccuracyUI();

        if (isFullyCorrect) {
            feedback.innerHTML = "ğŸ‰ å›ç­”æ­£ç¡®ï¼";
            feedback.className = "result-box res-correct";
        } else {
            const correctStr = document.getElementById('ans-hidden').innerText;
            feedback.innerHTML = `âŒ å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š${correctStr}`;
            feedback.className = "result-box res-wrong";
            if (runMode !== 'mistake' && runMode !== 'order') addToMistakes(runList[runIndex]);
        }
    }

    function addToMistakes(q) {
        const exists = mistakes.some(m => m.id === q.id && m.title === q.title);
        if (!exists) {
            mistakes.push(JSON.parse(JSON.stringify(q)));
            saveMistakes();
        }
    }

    function removeFromMistakes() {
        if(runMode !== 'mistake') return; 
        if(confirm("ç¡®å®šå·²æŒæ¡æ­¤é¢˜ï¼Ÿ")) {
            mistakes = mistakes.filter(m => m.id !== runList[runIndex].id);
            saveMistakes();
            runList.splice(runIndex, 1);
            showToast("ğŸ§¹ å·²ç§»é™¤é”™é¢˜");
            if(runList.length === 0) startPractice('mistake'); 
            else {
                if(runIndex >= runList.length) runIndex = runList.length - 1;
                renderQuestionCard(); 
            }
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        if(tab === 'practice') {
            document.querySelectorAll('.tab-item')[0].classList.add('active');
            document.getElementById('view-practice').classList.remove('hidden');
            document.getElementById('view-manage').classList.add('hidden');
            document.getElementById('app-title').innerText = "äº‘ç«¯é¢˜åº“";
            document.querySelector('.header-controls').classList.remove('hidden');
            if(document.getElementById('practice-area').classList.contains('hidden') && document.getElementById('empty-state-view').classList.contains('hidden')) {
                document.getElementById('dashboard').classList.remove('hidden');
            }
        } else {
            document.querySelectorAll('.tab-item')[1].classList.add('active');
            document.getElementById('view-practice').classList.add('hidden');
            document.getElementById('view-manage').classList.remove('hidden');
            document.getElementById('app-title').innerText = "é¢˜åº“ç®¡ç†";
            renderManageList();
        }
    }

    function handleSearch(val) {
        searchKeyword = val.toLowerCase();
        renderManageList();
    }

    function renderManageList() {
        const list = appData.questions[currentCategory] || [];
        const container = document.getElementById('manage-list');
        container.innerHTML = '';
        
        let visibleCount = 0;
        list.forEach((q, idx) => {
            let text = q.title + (q.options ? q.options.join('') : '') + q.answer;
            if (searchKeyword && !text.toLowerCase().includes(searchKeyword)) return;
            visibleCount++;

            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="check-area">
                    <input type="checkbox" class="list-check" value="${idx}" onchange="updateSelectedCount()">
                </div>
                <div class="list-info" onclick="editQuestion(${idx})">
                    <div>
                        <span style="font-weight:800; color:var(--primary); margin-right:5px;">${idx+1}.</span> 
                        <span class="badge ${getBadgeClass(q.type)}">${getTypeName(q.type)}</span>
                    </div>
                    <div class="list-title">${escapeHtml(q.title)}</div>
                </div>
                <div style="flex-shrink:0;">
                    <button class="btn btn-sm btn-outline" style="padding:4px 10px; border-radius:8px;" onclick="event.stopPropagation(); delQuestion(${idx})">ğŸ—‘ï¸</button>
                </div>
            `;
            container.appendChild(div);
        });

        if(visibleCount === 0) container.innerHTML = '<p style="text-align:center;color:var(--text-sub);padding:30px;">ğŸ” æ‰¾ä¸åˆ°ç›¸å…³é¢˜ç›®</p>';
        document.getElementById('select-all-box').checked = false;
        updateSelectedCount();
    }

    function toggleSelectAll(checkbox) {
        document.querySelectorAll('.list-check').forEach(c => c.checked = checkbox.checked);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.list-check:checked').length;
        document.getElementById('selected-count').innerText = count;
        const bar = document.getElementById('batch-bar');
        if(count > 0) bar.classList.add('visible');
        else bar.classList.remove('visible');
    }

    // --- è¿ç§»åŠŸèƒ½ (ä¿®å¤) ---
    function openMigrateModal() {
        const checks = document.querySelectorAll('.list-check:checked');
        if(checks.length === 0) return showToast("âš ï¸ è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€é“é¢˜ç›®");
        document.getElementById('migrate-count-display').innerText = checks.length;
        const sel = document.getElementById('target-cat-select');
        sel.innerHTML = '';
        let hasOtherCategories = false;
        appData.categories.forEach(cat => {
            if(cat !== currentCategory) {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.text = cat;
                sel.appendChild(opt);
                hasOtherCategories = true;
            }
        });
        if(!hasOtherCategories) return showToast("âš ï¸ è¯·å…ˆæ–°å»ºå…¶ä»–é¢˜åº“åˆ†ç±»ä»¥è¿›è¡Œè¿ç§»/å¤åˆ¶");
        document.getElementById('migrate-modal').classList.remove('hidden');
    }

    function executeMigrate(action) {
        const targetCat = document.getElementById('target-cat-select').value;
        if (!targetCat) return showToast("âš ï¸ è¯·é€‰æ‹©ç›®æ ‡åˆ†ç±»");

        const checks = Array.from(document.querySelectorAll('.list-check:checked'));
        if (checks.length === 0) {
            document.getElementById('migrate-modal').classList.add('hidden');
            return showToast("âš ï¸ æœªé€‰æ‹©ä»»ä½•é¢˜ç›®");
        }
        
        const indices = checks.map(c => parseInt(c.value)).sort((a,b) => b-a);
        const sourceList = appData.questions[currentCategory];
        const targetList = appData.questions[targetCat];
        
        let movedCount = 0;
        indices.forEach(idx => {
            const questionToMove = sourceList[idx];
            if(action === 'copy') {
                targetList.push(JSON.parse(JSON.stringify(questionToMove))); 
            } 
            else if (action === 'move') {
                targetList.push(questionToMove);
                sourceList.splice(idx, 1);
            }
            movedCount++;
        });

        document.getElementById('migrate-modal').classList.add('hidden');
        saveData();
        renderManageList(); 
        updateDashboardInfo();
        showToast(`âœ… å·²${action === 'copy' ? 'å¤åˆ¶' : 'ç§»åŠ¨'} ${movedCount} é¢˜åˆ° ${targetCat}`);
    }

    function getTypeName(t) { return t==='choice'?'å•é€‰':(t==='multiple'?'å¤šé€‰':(t==='judge'?'åˆ¤æ–­':(t==='essay'?'è®ºè¿°':'ç®€ç­”'))); }
    function getBadgeClass(t) { return t==='choice'?'badge-choice':(t==='multiple'?'badge-multiple':(t==='judge'?'badge-judge':(t==='essay'?'badge-essay':'badge-text'))); }
    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }

    function exportData() {
        const dataToExport = { appData, mistakes, totalGlobalCorrect };
        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `äº‘ç«¯é¢˜åº“å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        showToast("ğŸ“¤ é¢˜åº“æ•°æ®å·²å¯¼å‡º");
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(json.appData) {
                    if(confirm("å¯¼å…¥å°†è¦†ç›–æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        appData = json.appData;
                        mistakes = json.mistakes || []; 
                        if(json.totalGlobalCorrect) totalGlobalCorrect = json.totalGlobalCorrect;
                        saveData(); saveMistakes(); saveGlobalStats();
                        location.reload(); 
                    }
                } else showToast("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯");
            } catch(err) { showToast("âŒ è§£æå¤±è´¥"); }
        };
        reader.readAsText(file);
    }
    
    // å·¦å³æ»‘åŠ¨
    const qContainer = document.getElementById('question-card-container');
    let startX = 0; let endX = 0;
    qContainer.addEventListener('touchstart', (e) => startX = e.changedTouches[0].screenX, {passive: true});
    qContainer.addEventListener('touchend', (e) => {
        endX = e.changedTouches[0].screenX;
        if (endX - startX < -50) navQuestion(1);
        else if (endX - startX > 50) navQuestion(-1);
    }, {passive: true});
</script>
</body>
</html>